#!/usr/bin/env python3

import os
import yaml
from docopt import docopt


class shdocker:
    services = None

    def __init__(self, path='docker-compose.yml'):
        with open(path, 'r') as stream:
            self.services = yaml.load(stream)
            self.start()

    def link(self, service, target):
        if target == service:
            if 'links' in self.services[service]:
                for link in self.services[service]['links']:
                    self.link(service, link)
        else:
            cmd = '{}_link="$({})" '.format(target, self.services[target]['config']['cmd'])
            self.services[service]['config']['links'].append(cmd)

    def parse_image(self, service, image):
        self.services[service]['config']['image'] = image

    def parse_command(self, service, command):
        self.services[service]['config']['command'] = command

    def parse_build(self, service, build):
        self.services[service]['config']['image'] = service
        return 'docker build -t {} {} && '.format(service, build)

    def parse_ports(self, service, ports):
        for port in ports:
            self.services[service]['config']['options'].append('-p {}'.format(port))

    def parse_restart(self, service, restart):
        self.services[service]['config']['options'].append('--restart={}'.format(restart))

    def parse_volumes(self, service, volumes):
        for volume in volumes:
            self.services[service]['config']['options'].append('-v {}'.format(volume))

    def parse_environment(self, service, environment):
        for variable in environment:
            if environment[variable]:
                value = '${}'.format(environment[variable])
            else:
                value = variable
            self.services[service]['config']['options'].append('-e "{}={}"'.format(variable, value))

    def parse_volumes_from(self, service, volumes_from):
        for volumes_from_service in volumes_from:
            self.services[service]['config']['options'].append('--volumes-from {}'.format(volumes_from_service))

    def parse_links(self, service, links):
        for link in links:
            self.services[service]['config']['options'].append('--link "${}_link:{}"'.format(link, link))

    def parse_config(self, service, links):
        pass

    def parse(self, service):
        cmd = ''
        self.services[service]['config'] = {
            'options': [],
            'image': '',
            'command': '',
            'args': [],
            'links': []
        }

        for key in self.services[service]:
            val = self.services[service][key]
            parser = getattr(self, "parse_{}".format(key), False)
            if parser:
                ret = parser(service, val)
                if ret:
                    cmd += ret
            else:
                raise("No parser found for {}".format(service))

        return cmd

    def start(self):
        for service in self.services:
            cmd = self.parse(service)

            parts = ['docker run -d ',
                     ' '.join(self.services[service]['config']['options']),
                     ' ' + self.services[service]['config']['image'],
                     ' ' + self.services[service]['config']['command'],
                     ' '.join(self.services[service]['config']['args'])
                     ]

            run = ''.join(parts)
            cmd += run
            self.services[service]['config']['cmd'] = cmd

        for service in self.services:
            cmd = ''
            self.link(service, service)
            links = ''.join(self.services[service]['config']['links'])

            cmd += self.services[service]['config']['cmd']
            print('# {}'.format(service))

            print('{} {}'.format(links, cmd))

shd = shdocker('docker-compose.yml')
