#!/usr/bin/env python3

"""Docker Compose Shim

Usage:
  docker-compose build [options] <service>...
  docker-compose help <command>
  docker-compose kill [options] <service>...
  docker-compose logs [options] <service>...
  docker-compose port [options] <service> <service-port>
  docker-compose ps [options] <service>...
  docker-compose pull [options] <service>...
  docker-compose restart [options] <service>...
  docker-compose run [options] <service> [command] [args]
  docker-compose scale [options] [SERVICE=NUM]...
  docker-compose start <service>...
  docker-compose stop [options] <service>...
  docker-compose up [options] <service>...
  docker-compose migrate-to-labels
  docker-compose version [--short]

Options:
  -f --file=docker-compose.yml             use another compose file
  --p --project-name=$(basename $(pwd)     use another project name
  --verbose                                turn it up to 11
  -v --version                             print version

"""

import os
import yaml
from docopt import docopt


if __name__ == '__main__':
    arguments = docopt(__doc__, version='docker-compose-shellout 1.0.0')
    print(arguments)

dirname = os.path.split(os.path.dirname(
    os.path.realpath('docker-compose.yml')))[1]


class shdocker:
    services = None

    def __init__(self, path='docker-compose.yml'):
        with open(path, 'r') as stream:
            self.services = yaml.load(stream)
            self.start()

    def link(self, service):
        if 'links' in self.services[service]:
            cmd = ''
            for link in self.services[service]['links']:
                cmd += '{}_link="$({})" '.format(link, self.services[link]['config']['cmd'])
            return cmd

    def parse_image(self, service, image):
        self.services[service]['config']['image'] = image

    def parse_build(self, service, build):
        self.services[service]['config']['image'] = service
        return 'docker build -t {} {} && '.format(service, build)

    def parse_ports(self, service, ports):
        for port in ports:
            self.services[service]['config']['options'].append('-p {}'.format(port))

    def parse_volumes(self, service, volumes):
        for volume in volumes:
            self.services[service]['config']['options'].append('-v {}'.format(volume))

    def parse_environment(self, service, environment):
        for variable in environment:
            if environment[variable]:
                value = '${}'.format(environment[variable])
            else:
                value = variable
            self.services[service]['config']['options'].append('-e "{}={}"'.format(variable, value))

    def parse_volumes_from(self, service, volumes_from):
        for volumes_from_service in volumes_from:
            self.services[service]['config']['options'].append('--volumes-from {}'.format(volumes_from_service))

    def parse_links(self, service, links):
        for link in links:
            self.services[service]['config']['options'].append('--link "${}_link"'.format(link))

    def parse(self, service):
        cmd = ''
        self.services[service]['config'] = {
            'options': [],
            'image': '',
            'command': '',
            'args': []
        }

        for key in self.services[service]:
            val = self.services[service][key]
            parser = getattr(self, "parse_{}".format(key), False)
            if parser:
                ret = parser(service, val)
                if ret:
                    cmd += ret

        return cmd

    def start(self):
        for service in self.services:
            cmd = self.parse(service)

            parts = ['docker run -d ',
                     ' '.join(self.services[service]['config']['options']),
                     ' ' + self.services[service]['config']['image'],
                     ' ' + self.services[service]['config']['command'],
                     ' '.join(self.services[service]['config']['args'])
                     ]

            run = ''.join(parts)
            cmd += run
            self.services[service]['config']['cmd'] = cmd

        for service in self.services:
            cmd = ''
            ret = self.link(service)
            if ret:
                cmd = ret

            cmd += self.services[service]['config']['cmd']
            print('# {}'.format(service))
            print(cmd)
            print(' ')

shd = shdocker('docker-compose.yml')
